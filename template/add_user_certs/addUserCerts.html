{{template "header-tpl" .}}
<!-- {{template "menu-tpl" .}} -->
{{template "body-tpl" .}}

<!-- <div class="containers"> -->
  <div class="container-fluid">
    <div class="row">
      <!-- Левое меню -->
      <div class="left-menu-core">
        {{template "menu-left-tpl" .}}
      </div>
      <!-- Правая часть -->
      <div class="col p-1">
        <div class="row">
      <div class="col-2">
        <div class="left-core">
          <!-- Левая панель с сущьностями -->
          <div id="search-server" class="search-input-container-server">
            <input type="text" class="search-input" name="search-entity" placeholder="Search entitys">
          </div>
          {{template "entitysList-users-certs-tpl" .}}
        </div>
      </div>

      <!-- Правая панель с формой для создания сертификата -->
      <div class="col-7">
        <div><ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#"  hx-get="/overview" 
            hx-target="#body" 
            hx-swap="innerHTML transition:true" 
            hx-push-url="true">Overview</a></li>   
          <li class="breadcrumb-item"><a a href="#" hx-get="/add_entity" 
            hx-target="#body" 
            hx-swap="innerHTML transition:true" 
            hx-push-url="true">Add entities</a></li>
          <li class="breadcrumb-item active" aria-current="page">Add clients certs</li>
          <li class="breadcrumb-item"><a href="#" hx-get="/revoke_users_certs" 
            hx-target="#body" 
            hx-swap="innerHTML transition:true" 
            hx-push-url="true">Revoke clients certs</a></li>
        </ol></div>

        <div class="core-certs">
          <form class="" 
            hx-post="/add_users_certs" 
            hx-swap="none"
            hx-ext="json-enc-custom" 
            parse-types="true"
            hx-on::after-request="
              if (event.detail.xhr.responseText) {
                try {
                  const response = JSON.parse(event.detail.xhr.responseText);
                  if (response.status === 'error') {
                    Swal.fire({
                      showClass: { popup: 'animate__animated animate__fadeInUp animate__fast' },
                      hideClass: { popup: 'animate__animated animate__fadeOutDown animate__fast' },
                      customClass: 'custom-alert',
                      icon: 'error',
                      title: 'Ошибка',
                      text: response.message,
                      confirmButtonColor: '#3085d6'
                    });
                  } else if (response.status === 'success') {
                    Swal.fire({
                      showClass: { popup: 'animate__animated animate__fadeInUp animate__fast' },
                      hideClass: { popup: 'animate__animated animate__fadeOutDown animate__fast' },
                      customClass: 'custom-alert',
                      icon: 'success',
                      title: 'Успешно',
                      text: `Сертификат для сущьности ${response.CommonName} был успешно создан`,
                      confirmButtonColor: '#3085d6'
                    }).then(() => {
                      htmx.ajax('GET', '/user_cert_list', {
                        target: '#response', 
                        swap: 'innerHTML',  
                        values: {
                          EntityId: document.getElementById('entityId').value
                        } 
                      });
                    });
                  }
                } catch (e) {
                  console.error('Ошибка при обработке ответа:', e);
                }
              }
            ">
            <label id= "" class="form_lable" >Create client certificate</label>
            <div class="input_border color-form-certs">
              <div class="row g-3 form_center">
                <div class="col-md-3">
                  <label class="select_title">Algorithm</label>
                    <select id="select-type" name="Algorithm" class="select">
                      <option value="RSA" selected>RSA</option>
                      <option value="ECDSA">ECDSA</option>
                      <option value="ED25519">ED25519</option>
                    </select>
                </div>
                <div class="col-md-3">
                  <label class="select_title">Key Length</label>
                    <!-- RSA -->
                    <select id="select-key-length-rsa" class="select key-length-selector" data-algorithm="RSA" type="number">  
                      <option value="2048">2048 bits</option>
                      <option value="4096" selected>4096 bits</option>
                      <option value="8192">8192 bits</option>
                    </select>
                    <!-- ECDSA -->
                    <select id="select-key-length-ecdsa" class="select key-length-selector" data-algorithm="ECDSA" type="number" style="display:none;">  
                      <option value="256" selected>P-256 (256 bit)</option>
                      <option value="384">P-384 (384 bit)</option>
                      <option value="521">P-521 (521 bit)</option>
                    </select>
                    <!-- ED25519 -->
                    <select id="select-key-length-ed25519" class="select key-length-selector" data-algorithm="ED25519" type="number" style="display:none; pointer-events:none; opacity:0.6;">  
                      <option value="256" selected>256 bits</option>
                    </select>
                    <!-- Скрытое поле для отправки значения длины ключа-->
                    <input type="hidden" name="KeyLength" id="key-length-value" value="4096">
                </div>
                <div class="col-md-3">
                  <label class="select_title">TTL</label>
                  <input class="c_input" id="ttl" name="TTL" placeholder="TTL" value="365" required>
                </div>
                <div class="col-md-3">
                  <div class="form-check form-switch">
                    <label class="form-check-label" for="SwitchRecreate">Recreate</label>
                    <input class="form-check-input" type="checkbox" role="switch" id="SwitchRecreate" name="recreate" checked>
                  </div>
                </div>
              </div>
              <div class="indent-5"></div>
              <div class="row g-3 form_center">
                <div class="col-md-3">
                  <label class="select_title" title="Обязательное поле">Common Name</label>
                  <input title="Обязательное поле" type="text" class="c_input" id="Common" name="CommonName" placeholder="CN" required>
                </div>

                <div class="col-md-9">
                  <label class="select_title">Subject Alternative Names</label>
                  <div class="tags-container">
                    <input type="text" 
                      id="san-input"
                      class="c_input tag-input"
                      placeholder="izhevsk.dynamics.ru, www.example.ru, John Doe">
                    
                    <div id="san-tags" class="tags">
                      <!-- Теги будут добавляться сюда -->
                    </div>
                    <input type="hidden" name="SAN" id="san-values" value="" data-string="true">
                  </div>
                </div>

                <div class="col-md-3">
                  <label class="select_title">OID Custom</label>
                    <select data-placeholder="true" id="select-oid-custom-subject" name="OID" class="select">  
                      <option value="" disabled selected hidden>Select OID</option>
                      {{ range .oidList }}
                        <option value="{{ .OIDName }}">{{ .OIDName }} - {{ .OIDDescription }}</option>
                      {{ end }}
                    </select>
                </div>

                <div class="col-md-9">
                  <label class="select_title">OID Custom Values</label>
                  <div class="tags-container">
                    <input type="text" 
                      id="oid-input"
                      class="c_input tag-input"
                      placeholder="Any values">
                    
                    <div id="oid-tags" class="tags">
                      <!-- Теги будут добавляться сюда -->
                    </div>
                    <input type="hidden" name="OIDValues" id="oid-values" value="" data-string="true">
                  </div>
                </div>

              </div>
              <div class="row g-3 form_center">
                <div class="col-md-3">
                  <label class="select_title">Country Name</label>
                  <input type="text" class="c_input" id="Country" name="CountryName" placeholder="RU" required>
                </div>
                <div class="col-md-3">
                  <label class="select_title">State or Province</label>
                  <input type="text" class="c_input" id="State" name="StateProvince" placeholder="Udmurt Republic" required>
                </div>
                <div class="col-md-3">
                  <label class="select_title">Locality Name</label>
                  <input type="text" class="c_input" id="Locality" name="LocalityName" placeholder="Izhevsk" required>
                </div>
              </div>
              <div class="indent-5"></div> 
              <div class="row g-3 form_center">
                <div class="col-md-3">
                  <label class="select_title">Organization Name</label>
                  <input type="text" class="c_input" id="Organization" name="Organization" placeholder="LV Inc." required>
                </div>
                <div class="col-md-3">
                  <label class="select_title">Organizational Unit</label>
                  <input type="text" class="c_input" id="Unit" name="OrganizationUnit" placeholder="IT" required>
                </div>
                <div class="col-md-3">
                  <label class="select_title">Email Address</label>
                  <input type="email" class="c_input" id="Email" name="Email" placeholder="tdv@test.ru" required>
                </div>

                <div class="col-md-3" style="display: none;">
                  <input type="number" id="entityId" name="EntityId" value="">
                </div>
                <div class="col-md-3">
                  <label for="standard-select" class="select_title">Password container</label>
                  <input type="password" class="c_input" id="Password" name="Password" placeholder="****" data-string="true" required>
                </div>
                <div class="btn-container btn-container-right">
                  <button type="submit" class="btn-custom btn-custom-certs" id="create-cert-btn">
                    <span class="btn-text">Create</span>
                    <img src="/static/svg/time.svg" class="time-svg htmx-indicator">
                  </button>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Поиск и список сертификатов -->
    <div class="row mt-2">
      <div class="col-12">
        <div id="search-certs" class="search-input-container">
          <input type="text" class="search-input" name="search-certs" placeholder="Search certs">
        </div>
        <div id="response" class="server-cert-tables">
          {{template "certUserList-tpl" .}}
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- index end template -->
{{template "footer-tpl" .}}
